<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Attention Clock — A gentle rhythm of focus</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github.min.css"
    />
    <style>
      :root {
        --color-dawn: #fef3e2;
        --color-morning: #ffd89b;
        --color-midday: #ffb347;
        --color-afternoon: #de6262;
        --color-evening: #7f6a93;
        --color-night: #2c3e50;
        --color-bg: #fafaf9;
        --color-text: #374151;
        --color-text-light: #6b7280;
        --color-border: #e5e7eb;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
          Arial, sans-serif;
        background: linear-gradient(135deg, var(--color-bg) 0%, #f0f0f0 100%);
        color: var(--color-text);
        line-height: 1.6;
        overflow-x: hidden;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }

      header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem 0;
      }

      h1 {
        font-size: 2.5rem;
        font-weight: 300;
        color: var(--color-night);
        margin-bottom: 0.5rem;
        letter-spacing: -0.5px;
      }

      .subtitle {
        font-size: 1.1rem;
        color: var(--color-text-light);
        font-weight: 300;
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.8;
      }

      .section {
        background: white;
        border-radius: 16px;
        padding: 2.5rem;
        margin-bottom: 2.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        transition: box-shadow 0.3s ease;
      }

      .section:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
      }

      .section-title {
        font-size: 1.75rem;
        font-weight: 400;
        color: var(--color-night);
        margin-bottom: 0.75rem;
        letter-spacing: -0.3px;
      }

      .section-description {
        color: var(--color-text-light);
        margin-bottom: 2rem;
        font-size: 1.05rem;
        line-height: 1.7;
      }

      #circadian-viz,
      #daily-viz,
      #domain-viz {
        width: 100%;
        min-height: 400px;
      }

      .insight-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-left: 4px solid var(--color-afternoon);
        padding: 1.5rem;
        border-radius: 8px;
        margin-top: 1.5rem;
      }

      .insight-card h3 {
        font-size: 1.2rem;
        font-weight: 500;
        color: var(--color-night);
        margin-bottom: 0.5rem;
      }

      .insight-card p {
        margin: 0;
        color: var(--color-text);
      }

      .stat {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: rgba(127, 106, 147, 0.1);
        border-radius: 20px;
        font-weight: 500;
        color: var(--color-evening);
        margin: 0 0.25rem;
      }

      .legend {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1.5rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: var(--color-text-light);
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
      }

      .loading {
        text-align: center;
        padding: 3rem;
        color: var(--color-text-light);
        font-size: 1.1rem;
      }

      footer {
        text-align: center;
        padding: 2rem 0;
        color: var(--color-text-light);
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Your Attention Clock</h1>
        <p class="subtitle">
          A gentle map of where your focus flows across the week — not to judge, but to understand
          the natural rhythm of your days
        </p>
      </header>

      <div class="section">
        <h2 class="section-title">The Circadian Pulse</h2>
        <p class="section-description">
          Each cell shows your browsing attention across the week. Warmer colors = deeper
          engagement. See when you naturally focus, when you drift, and when you rest.
        </p>
        <div id="circadian-viz" class="loading">Loading your attention rhythm...</div>
      </div>

      <div class="section">
        <h2 class="section-title">Daily Ebb & Flow</h2>
        <p class="section-description">
          Your browsing activity over time. Notice the patterns: the productive days, the quieter
          moments, the weekends that breathe differently.
        </p>
        <div id="daily-viz" class="loading">Loading daily patterns...</div>
      </div>

      <div class="section">
        <h2 class="section-title">Where Your Attention Lives</h2>
        <p class="section-description">
          The domains that held your focus. Not all attention is equal — some feeds you, some
          drains you. This is a starting point for gentle adjustment.
        </p>
        <div id="domain-viz" class="loading">Loading top domains...</div>
      </div>

      <footer>
        <p>
          Generated with care from your browsing history &middot; A reflective tool, not a
          judgment
        </p>
      </footer>
    </div>

    <script type="module">
      import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
      import { num0, num2 } from "https://cdn.jsdelivr.net/npm/@gramex/ui@0.3/dist/format.js";

      const $ = (s, el = document) => el.querySelector(s);

      // Helper: format seconds to human-readable
      function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        if (hours > 0) return `${hours}h ${mins}m`;
        return `${mins}m`;
      }

      // Load all data
      async function loadData() {
        const [hourlyData, dailyData, domainData] = await Promise.all([
          d3.csv("attention_by_hour.csv", (d) => ({
            dow: +d.dow,
            hour: +d.hour,
            visits: +d.visits,
            seconds: +d.seconds,
          })),
          d3.csv("attention_by_day.csv", (d) => ({
            date: new Date(d.date),
            visits: +d.visits,
            seconds: +d.seconds,
          })),
          d3.csv("domain_top.csv", (d) => ({
            domain: d.domain,
            visits: +d.visits,
            seconds: +d.total_fg_seconds,
            days: +d.unique_days,
          })),
        ]);

        return { hourlyData, dailyData, domainData };
      }

      // Visualization 1: Circadian Heatmap
      function renderCircadianHeatmap(data, container) {
        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const margin = { top: 40, right: 40, bottom: 60, left: 80 };
        const cellSize = 45;
        const width = 24 * cellSize + margin.left + margin.right;
        const height = 7 * cellSize + margin.top + margin.bottom;

        $("#circadian-viz").innerHTML = "";
        const svg = d3
          .select("#circadian-viz")
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .attr("viewBox", `0 0 ${width} ${height}`)
          .style("max-width", "100%")
          .style("height", "auto");

        const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        // Color scale
        const maxSeconds = d3.max(data, (d) => d.seconds);
        const colorScale = d3
          .scaleSequential()
          .domain([0, maxSeconds])
          .interpolator(d3.interpolateRgb("#fef3e2", "#de6262"));

        // Create cells
        const cells = g
          .selectAll(".cell")
          .data(data)
          .join("g")
          .attr("class", "cell")
          .attr("transform", (d) => `translate(${d.hour * cellSize},${d.dow * cellSize})`);

        cells
          .append("rect")
          .attr("width", cellSize - 2)
          .attr("height", cellSize - 2)
          .attr("rx", 4)
          .attr("fill", (d) => (d.seconds > 0 ? colorScale(d.seconds) : "#f9f9f9"))
          .attr("stroke", "#e5e7eb")
          .attr("stroke-width", 1)
          .style("cursor", "pointer")
          .on("mouseover", function (event, d) {
            d3.select(this).attr("stroke", "#374151").attr("stroke-width", 2);
            showTooltip(event, d);
          })
          .on("mouseout", function () {
            d3.select(this).attr("stroke", "#e5e7eb").attr("stroke-width", 1);
            hideTooltip();
          });

        // Add hour labels (top)
        g.selectAll(".hour-label")
          .data(d3.range(24))
          .join("text")
          .attr("class", "hour-label")
          .attr("x", (d) => d * cellSize + cellSize / 2)
          .attr("y", -10)
          .attr("text-anchor", "middle")
          .attr("font-size", "11px")
          .attr("fill", "#6b7280")
          .text((d) => `${d.toString().padStart(2, "0")}`);

        // Add day labels (left)
        g.selectAll(".day-label")
          .data(dayNames)
          .join("text")
          .attr("class", "day-label")
          .attr("x", -10)
          .attr("y", (d, i) => i * cellSize + cellSize / 2)
          .attr("text-anchor", "end")
          .attr("dominant-baseline", "middle")
          .attr("font-size", "13px")
          .attr("fill", "#374151")
          .attr("font-weight", "500")
          .text((d) => d);

        // Tooltip
        const tooltip = d3
          .select("body")
          .append("div")
          .attr("id", "tooltip")
          .style("position", "absolute")
          .style("background", "rgba(0, 0, 0, 0.85)")
          .style("color", "white")
          .style("padding", "10px 14px")
          .style("border-radius", "8px")
          .style("font-size", "13px")
          .style("pointer-events", "none")
          .style("opacity", 0)
          .style("z-index", 1000);

        function showTooltip(event, d) {
          tooltip.transition().duration(200).style("opacity", 1);
          tooltip
            .html(
              `<strong>${dayNames[d.dow]}, ${d.hour}:00</strong><br/>
               ${num0(d.visits)} visits<br/>
               ${formatTime(d.seconds)} active`
            )
            .style("left", event.pageX + 15 + "px")
            .style("top", event.pageY - 30 + "px");
        }

        function hideTooltip() {
          tooltip.transition().duration(200).style("opacity", 0);
        }

        // Add insights
        const totalSeconds = d3.sum(data, (d) => d.seconds);
        const totalHours = Math.round(totalSeconds / 3600);
        const peakHour = data.reduce((a, b) => (a.seconds > b.seconds ? a : b));
        const avgDaySeconds = totalSeconds / 7;

        const insightHtml = `
          <div class="insight-card">
            <h3>Your Weekly Rhythm</h3>
            <p>
              You spent about <span class="stat">${totalHours} hours</span> browsing this period.
              Your peak attention? <span class="stat">${dayNames[peakHour.dow]} at ${peakHour.hour}:00</span> —
              averaging <span class="stat">${formatTime(avgDaySeconds)}</span> of active browsing per day.
            </p>
          </div>
        `;
        $("#circadian-viz").insertAdjacentHTML("beforeend", insightHtml);
      }

      // Visualization 2: Daily Timeline
      function renderDailyTimeline(data, container) {
        const margin = { top: 40, right: 60, bottom: 60, left: 60 };
        const width = 1100;
        const height = 350;

        $("#daily-viz").innerHTML = "";
        const svg = d3
          .select("#daily-viz")
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .attr("viewBox", `0 0 ${width} ${height}`)
          .style("max-width", "100%")
          .style("height", "auto");

        const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        // Scales
        const xScale = d3
          .scaleTime()
          .domain(d3.extent(data, (d) => d.date))
          .range([0, innerWidth]);

        const yScale = d3
          .scaleLinear()
          .domain([0, d3.max(data, (d) => d.seconds)])
          .range([innerHeight, 0])
          .nice();

        // Axes
        const xAxis = d3.axisBottom(xScale).ticks(8).tickFormat(d3.timeFormat("%b %d"));
        const yAxis = d3
          .axisLeft(yScale)
          .ticks(6)
          .tickFormat((d) => formatTime(d));

        g.append("g")
          .attr("transform", `translate(0,${innerHeight})`)
          .call(xAxis)
          .attr("color", "#6b7280")
          .selectAll("text")
          .attr("font-size", "11px");

        g.append("g").call(yAxis).attr("color", "#6b7280").selectAll("text").attr("font-size", "11px");

        // Area chart
        const area = d3
          .area()
          .x((d) => xScale(d.date))
          .y0(innerHeight)
          .y1((d) => yScale(d.seconds))
          .curve(d3.curveMonotoneX);

        const gradient = svg
          .append("defs")
          .append("linearGradient")
          .attr("id", "area-gradient")
          .attr("gradientTransform", "rotate(90)");

        gradient.append("stop").attr("offset", "0%").attr("stop-color", "#ffb347").attr("stop-opacity", 0.4);
        gradient.append("stop").attr("offset", "100%").attr("stop-color", "#de6262").attr("stop-opacity", 0.1);

        g.append("path")
          .datum(data)
          .attr("fill", "url(#area-gradient)")
          .attr("d", area);

        // Line
        const line = d3
          .line()
          .x((d) => xScale(d.date))
          .y((d) => yScale(d.seconds))
          .curve(d3.curveMonotoneX);

        g.append("path")
          .datum(data)
          .attr("fill", "none")
          .attr("stroke", "#de6262")
          .attr("stroke-width", 2.5)
          .attr("d", line);

        // Add insights
        const avgSeconds = d3.mean(data, (d) => d.seconds);
        const maxDay = data.reduce((a, b) => (a.seconds > b.seconds ? a : b));
        const minDay = data.reduce((a, b) => (a.seconds < b.seconds ? a : b));

        const insightHtml = `
          <div class="insight-card">
            <h3>Daily Patterns</h3>
            <p>
              Your average day: <span class="stat">${formatTime(avgSeconds)}</span> of browsing.
              Your most engaged day was <span class="stat">${d3.timeFormat("%B %d")(maxDay.date)}</span>
              (${formatTime(maxDay.seconds)}), and your quietest was
              <span class="stat">${d3.timeFormat("%B %d")(minDay.date)}</span> (${formatTime(minDay.seconds)}).
            </p>
          </div>
        `;
        $("#daily-viz").insertAdjacentHTML("beforeend", insightHtml);
      }

      // Visualization 3: Domain Bar Chart
      function renderDomainChart(data, container) {
        const topDomains = data.slice(0, 15);
        const margin = { top: 20, right: 60, bottom: 40, left: 240 };
        const width = 1100;
        const height = 600;

        $("#domain-viz").innerHTML = "";
        const svg = d3
          .select("#domain-viz")
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .attr("viewBox", `0 0 ${width} ${height}`)
          .style("max-width", "100%")
          .style("height", "auto");

        const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        // Scales
        const xScale = d3
          .scaleLinear()
          .domain([0, d3.max(topDomains, (d) => d.seconds)])
          .range([0, innerWidth]);

        const yScale = d3
          .scaleBand()
          .domain(topDomains.map((d) => d.domain))
          .range([0, innerHeight])
          .padding(0.2);

        // Color scale
        const colorScale = d3
          .scaleSequential()
          .domain([0, topDomains.length])
          .interpolator(d3.interpolateRgb("#7f6a93", "#ffb347"));

        // Bars
        g.selectAll(".bar")
          .data(topDomains)
          .join("rect")
          .attr("class", "bar")
          .attr("x", 0)
          .attr("y", (d) => yScale(d.domain))
          .attr("width", (d) => xScale(d.seconds))
          .attr("height", yScale.bandwidth())
          .attr("fill", (d, i) => colorScale(i))
          .attr("rx", 4);

        // Labels
        g.selectAll(".domain-label")
          .data(topDomains)
          .join("text")
          .attr("class", "domain-label")
          .attr("x", -10)
          .attr("y", (d) => yScale(d.domain) + yScale.bandwidth() / 2)
          .attr("text-anchor", "end")
          .attr("dominant-baseline", "middle")
          .attr("font-size", "12px")
          .attr("fill", "#374151")
          .text((d) => d.domain);

        // Time labels on bars
        g.selectAll(".time-label")
          .data(topDomains)
          .join("text")
          .attr("class", "time-label")
          .attr("x", (d) => xScale(d.seconds) + 8)
          .attr("y", (d) => yScale(d.domain) + yScale.bandwidth() / 2)
          .attr("dominant-baseline", "middle")
          .attr("font-size", "11px")
          .attr("fill", "#6b7280")
          .attr("font-weight", "500")
          .text((d) => formatTime(d.seconds));

        // Add insights
        const topThree = topDomains.slice(0, 3);
        const totalTopSeconds = d3.sum(topThree, (d) => d.seconds);
        const totalSeconds = d3.sum(data, (d) => d.seconds);
        const topPct = Math.round((totalTopSeconds / totalSeconds) * 100);

        const insightHtml = `
          <div class="insight-card">
            <h3>Where You Spend Your Time</h3>
            <p>
              Your top 3 domains — <strong>${topThree.map((d) => d.domain).join(", ")}</strong> —
              account for <span class="stat">${topPct}%</span> of your total browsing time.
              That's <span class="stat">${formatTime(totalTopSeconds)}</span> in these spaces alone.
              Does this distribution feel right to you?
            </p>
          </div>
        `;
        $("#domain-viz").insertAdjacentHTML("beforeend", insightHtml);
      }

      // Main initialization
      (async function init() {
        try {
          const { hourlyData, dailyData, domainData } = await loadData();

          renderCircadianHeatmap(hourlyData, "#circadian-viz");
          renderDailyTimeline(dailyData, "#daily-viz");
          renderDomainChart(domainData, "#domain-viz");
        } catch (error) {
          console.error("Error loading data:", error);
          document.querySelectorAll(".loading").forEach((el) => {
            el.textContent = "Error loading data. Please check the console.";
            el.style.color = "#dc2626";
          });
        }
      })();
    </script>
  </body>
</html>
